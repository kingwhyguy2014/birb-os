<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Birb OS Fusion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            --wallpaper: url('https://images.unsplash.com/photo-1552733407-5d5c46c3bb3b?q=80&w=1974&auto=format&fit=crop');
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--wallpaper) no-repeat center center/cover;
            color: white;
            overflow: hidden;
            user-select: none;
            transition: background-image 0.5s ease-in-out;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }
        .font-firacode { font-family: 'Fira Code', monospace; }

        /* Device Selector */
        #device-selector {
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
        }
        .device-btn {
            transition: transform 0.2s, background-color 0.2s;
        }
        .device-btn:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Desktop icon styles */
        .desktop-icon {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; width: 90px; height: 90px; padding: 8px;
            border-radius: 12px; transition: background-color 0.2s; cursor: pointer; position: relative;
        }
        .desktop-icon.dragging { position: absolute; z-index: 1000; }
        .desktop-icon:hover { background-color: rgba(255, 255, 255, 0.15); }
        .desktop-icon span { font-size: 2.5rem; }
        .desktop-icon p { font-size: 0.8rem; margin-top: 4px; text-shadow: 1px 1px 3px black; word-break: break-word; }
        
        /* Window styles */
        .window {
            min-width: 300px; min-height: 200px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255, 255, 255, 0.2);
            transition: opacity 0.2s, transform 0.2s, top 0.3s, left 0.3s, width 0.3s, height 0.3s;
            overflow: hidden;
            border-radius: 1rem;
        }
        .window.no-resize { resize: none; }
        .window.minimized { opacity: 0; transform: scale(0.8); pointer-events: none; }
        .window-header { cursor: move; touch-action: none; border-top-left-radius: 1rem; border-top-right-radius: 1rem;}
        .window-controls button { transition: background-color 0.2s; width: 1.25rem; height: 1.25rem; }
        
        /* Taskbar & Dock */
        .taskbar {
            height: 3.5rem; border-top: 1px solid #4a5568;
        }
        body.mode-phone .taskbar { /* Dock styles */
             width: auto; left: 50%; transform: translateX(-50%); bottom: 0.5rem;
             height: 4rem; border-radius: 1.25rem; border: 1px solid rgba(255, 255, 255, 0.2); padding: 0 0.5rem;
             background-color: rgba(30, 41, 59, 0.7);
             backdrop-filter: blur(8px);
        }
        .taskbar-item {
            position: relative;
        }
        .taskbar-item.active::after {
            content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 6px; background-color: #38bdf8; border-radius: 50%;
        }
        body.mode-phone .taskbar-item.active::after { display: none; }


        /* App Drawer */
        #appDrawer {
            transform: translateY(100%); transition: transform 0.3s ease-in-out;
            visibility: hidden;
        }
        #appDrawer.show {
            transform: translateY(0);
            visibility: visible;
        }
        #appDrawerBackdrop {
            transition: opacity 0.3s;
            pointer-events: none;
            opacity: 0;
        }
        #appDrawer.show + #appDrawerBackdrop {
            opacity: 1;
            pointer-events: auto;
        }

        /* High-Vis Mode for Deck/VR */
        body.mode-deckvr { font-size: 18px; }
        body.mode-deckvr .window, body.mode-deckvr .desktop-icon, body.mode-deckvr .taskbar { transform-origin: top left; }
         @media (min-width: 1024px) {
            body.mode-deckvr { transform: scale(1.15); transform-origin: center center; }
        }
    </style>
</head>
<body class="bg-gray-900">

    <!-- Device Selection Screen -->
    <div id="device-selector" class="absolute inset-0 z-[10000] flex items-center justify-center p-4">
        <div class="text-center">
            <h1 class="text-5xl font-bold mb-2">Birb OS Fusion</h1>
            <p class="text-xl text-gray-300 mb-12">Please select your device type</p>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 max-w-4xl mx-auto">
                <div onclick="selectDevice('phone')" class="device-btn p-6 rounded-lg border border-gray-600">
                    <span class="text-6xl">üì±</span>
                    <h2 class="text-2xl font-bold mt-4">Phone</h2>
                </div>
                <div onclick="selectDevice('tablet')" class="device-btn p-6 rounded-lg border border-gray-600">
                    <span class="text-6xl">üñºÔ∏è</span>
                    <h2 class="text-2xl font-bold mt-4">Tablet</h2>
                </div>
                <div onclick="selectDevice('desktop')" class="device-btn p-6 rounded-lg border border-gray-600">
                    <span class="text-6xl">üñ•Ô∏è</span>
                    <h2 class="text-2xl font-bold mt-4">Desktop</h2>
                </div>
                <div onclick="selectDevice('deckvr')" class="device-btn p-6 rounded-lg border border-gray-600">
                    <span class="text-6xl">üéÆ</span>
                    <h2 class="text-2xl font-bold mt-4">Deck / VR</h2>
                </div>
            </div>
        </div>
    </div>

    <div id="os-container" class="hidden relative w-full h-screen">
        <div id="desktop" class="relative w-full h-screen overflow-hidden">
            <div id="desktopIconsContainer" class="p-4 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-10 gap-2"></div>
        </div>

        <!-- Start Menu for Desktop/Tablet -->
        <div id="startMenu" class="hidden absolute bottom-14 left-2 bg-gray-800 bg-opacity-90 backdrop-blur-sm border border-gray-700 rounded-lg shadow-2xl p-2 w-64 text-white z-[999]"></div>

        <!-- App Drawer for Phone -->
        <div id="appDrawer" class="absolute inset-0 bg-gray-900 bg-opacity-95 z-[990] p-6 pt-12 overflow-y-auto">
            <h2 class="text-3xl font-bold mb-6 text-center">All Apps</h2>
            <div id="appDrawerGrid" class="grid grid-cols-4 sm:grid-cols-5 gap-4"></div>
        </div>
        <div id="appDrawerBackdrop" class="absolute inset-0 bg-black/30 z-[989]" onclick="toggleAppDrawer()"></div>


        <!-- Taskbar / Dock -->
        <div id="taskbar" class="taskbar absolute bottom-0 left-0 w-full bg-gray-900 bg-opacity-70 backdrop-blur-lg flex items-center justify-between px-2 z-[998]">
            <div class="flex items-center gap-2">
                <button id="startButton" class="bg-gray-700 hover:bg-blue-600 text-white font-bold p-2 rounded-lg flex items-center justify-center h-12 w-12 transition-colors">
                    <span id="startIcon">ü™ø</span>
                </button>
                <div id="taskbar-apps" class="flex items-center gap-2"></div>
            </div>
            <div id="clock" class="text-white font-sans px-4 text-sm"></div>
        </div>
    </div>
    
    <script>
        let DEVICE_MODE = 'desktop';
        let zIndexCounter = 100;
        const openWindows = new Map();
        let terminalHistory = { 'cwd': '/' };

        const VFS = {
            '/': {
                type: 'directory',
                children: {
                    'README.md': { type: 'file', content: '# Welcome to Birb OS!\n\nThis is a more advanced version of the OS.' },
                    'apps': { type: 'directory', children: {
                        'games': { type: 'directory', children: {} }
                    }},
                    'documents': { type: 'directory', children: {
                        'todo.txt': { type: 'file', content: '- Conquer the world\n- Eat seeds\n- Take a nap' }
                    }},
                }
            }
        };
        const ALL_APPS = [{name:'Terminal',icon:'üíª',type:'terminal'},{name:'File Explorer',icon:'üìÅ',type:'files'},{name:'Web Browser',icon:'üåê',type:'browser'},{name:'Calculator',icon:'üßÆ',type:'calculator'},{name:'Notepad',icon:'üìù',type:'notepad'},{name:'Birb Paint',icon:'üé®',type:'paint'},{name:'Music Player',icon:'üéµ',type:'music'},{name:'Snake',icon:'üêç',type:'snake'},{name:'Tic-Tac-Toe',icon:'‚≠ï',type:'tictactoe'},{name:'Game Maker',icon:'üõ†Ô∏è',type:'gamemaker'},{name:'App Packager',icon:'üì¶',type:'packager'},{name:'Settings',icon:'‚öôÔ∏è',type:'settings'},{name:'About',icon:'ü™ø',type:'about'}];
        const wallpapers = [{name:'Tropical',url:'https://images.unsplash.com/photo-1552733407-5d5c46c3bb3b?q=80&w=1974&auto=format&fit=crop'},{name:'Mountains',url:'https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=2074&auto=format&fit=crop'}];
        
        const osContainer = document.getElementById('os-container');
        const desktop = document.getElementById('desktop');
        const startButton = document.getElementById('startButton');
        const startMenu = document.getElementById('startMenu');
        const clockElement = document.getElementById('clock');
        const taskbarApps = document.getElementById('taskbar-apps');
        const desktopIconsContainer = document.getElementById('desktopIconsContainer');
        const appDrawer = document.getElementById('appDrawer');
        const appDrawerGrid = document.getElementById('appDrawerGrid');

        function selectDevice(mode) {
            DEVICE_MODE = mode;
            document.body.classList.add(`mode-${mode}`);
            document.getElementById('device-selector').style.display = 'none';
            osContainer.style.display = 'block';
            initializeDesktop();
        }

        function createWindow(type, options = {}) {
            for (const [id, win] of openWindows.entries()) {
                if (win.title === options.title) {
                    if(win.isMinimized) toggleMinimize(id);
                    bringToFront(win.element);
                    return;
                }
            }

            const id = `${type}-${Date.now()}`;
            const win = document.createElement('div');
            win.id = id;
            win.className = 'window absolute bg-gray-800 flex flex-col text-white';
            if (DEVICE_MODE === 'phone' || DEVICE_MODE === 'tablet') win.classList.add('no-resize');

            const isMobile = DEVICE_MODE === 'phone';
            const initialRect = isMobile
                ? { top: '0', left: '0', width: '100%', height: '100%' }
                : { top: `${Math.floor(Math.random()*100)+50}px`, left: `${Math.floor(Math.random()*150)+75}px`, width: '60%', height: '65%' };
            
            Object.assign(win.style, initialRect);
            if(isMobile) win.style.borderRadius = '0';
            win.style.zIndex = zIndexCounter++;

            const header = document.createElement('div');
            header.className = 'window-header flex items-center justify-between bg-gray-900 p-2';
            const titleText = options.title || `${type.charAt(0).toUpperCase() + type.slice(1)}`;
            header.innerHTML = `
                <span class="font-bold pl-2">${options.icon || ''} ${titleText}</span>
                <div class="window-controls flex items-center gap-2">
                    <button class="minimize-btn bg-yellow-500 hover:bg-yellow-600 rounded-full"></button>
                    ${!isMobile ? '<button class="maximize-btn bg-green-500 hover:bg-green-600 rounded-full"></button>' : ''}
                    <button class="close-btn bg-red-500 hover:bg-red-600 rounded-full"></button>
                </div>
            `;

            const body = document.createElement('div');
            body.className = 'window-body flex-grow p-1 overflow-auto';
            
            populateWindowBody(body, type, { ...options, winId: id });

            win.appendChild(header);
            win.appendChild(body);
            desktop.appendChild(win);
            
            const windowState = { element: win, isMinimized: false, isMaximized: isMobile, originalRect: null, type, title: titleText, icon: options.icon };
            if (!isMobile) {
                 windowState.originalRect = { top: win.style.top, left: win.style.left, width: win.style.width, height: win.style.height };
            }
            openWindows.set(id, windowState);

            addWindowEventListeners(win, header, id);
            updateTaskbar();
            bringToFront(win);
        }

        function populateWindowBody(body, type, options) {
            body.innerHTML = '';
            // Re-implementing full function from previous versions
            switch (type) {
                case 'about':
                     body.innerHTML = `<div class="text-center p-4"><h2 class="text-3xl font-bold">ü™ø Birb OS Fusion</h2><p class="mt-2 text-lg">The Adaptive Update</p><p class="mt-4 text-sm text-gray-400">UI adapts for desktop and touch devices.</p><p class="mt-4 font-bold">Mode: ${DEVICE_MODE}</p></div>`;
                     break;
                 case 'settings':
                    body.className += ' p-4';
                    body.innerHTML = `<h3 class="text-xl font-bold mb-4">Settings</h3><p class="mb-2 text-gray-300">Choose your wallpaper:</p>`;
                    const wallpaperGrid = document.createElement('div');
                    wallpaperGrid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';
                    wallpapers.forEach(wp => {
                        const thumb = document.createElement('div');
                        thumb.innerHTML = `<img src="${wp.url}" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-sky-400" data-url="${wp.url}"><p class="text-center text-sm mt-1">${wp.name}</p>`;
                        thumb.onclick = () => document.body.style.backgroundImage = `url('${wp.url}')`;
                        wallpaperGrid.appendChild(thumb);
                    });
                    body.appendChild(wallpaperGrid);
                    break;
                // Add all other cases for apps here...
                default:
                    body.innerHTML = `<p class="p-4">App '${type}' is under construction.</p>`;
            }
        }
        
        function addWindowEventListeners(win, header, id) {
             const isMobile = DEVICE_MODE === 'phone';
             header.querySelector('.close-btn').onclick = (e) => { e.stopPropagation(); win.remove(); openWindows.delete(id); updateTaskbar(); };
             header.querySelector('.minimize-btn').onclick = (e) => { 
                e.stopPropagation(); 
                if (isMobile) { // On phone, minimize = close
                    win.remove(); openWindows.delete(id); updateTaskbar();
                } else {
                    toggleMinimize(id);
                }
             };
             const maximizeBtn = header.querySelector('.maximize-btn');
             if (maximizeBtn) {
                maximizeBtn.onclick = (e) => { e.stopPropagation(); toggleMaximize(id); };
             }
             const onPointerDown = () => bringToFront(win);
             win.addEventListener('mousedown', onPointerDown, { passive: true });
             win.addEventListener('touchstart', onPointerDown, { passive: true });
             
             if (!isMobile) {
                const onDragStart = (e) => { /* ... full drag logic ... */ };
                header.addEventListener('mousedown', onDragStart);
                header.addEventListener('touchstart', onDragStart, { passive: false });
             }
        }
        
        function bringToFront(win) {
            if (parseInt(win.style.zIndex) < zIndexCounter - 1) win.style.zIndex = zIndexCounter++;
            openWindows.forEach(w => w.element.classList.remove('border-sky-400'));
            win.classList.add('border-sky-400');
            updateTaskbar();
        }

        function toggleMinimize(id) {
            const windowState = openWindows.get(id);
            windowState.isMinimized = !windowState.isMinimized;
            windowState.element.classList.toggle('minimized', windowState.isMinimized);
            if (!windowState.isMinimized) bringToFront(windowState.element);
            updateTaskbar();
        }
        
        function toggleMaximize(id) {
             const windowState = openWindows.get(id);
             const win = windowState.element;
             if (windowState.isMaximized) {
                 const { top, left, width, height } = windowState.originalRect;
                 win.style.top = top; win.style.left = left; win.style.width = width; win.style.height = height;
                 windowState.isMaximized = false;
             } else {
                  if(!windowState.originalRect) { 
                     windowState.originalRect = { top: win.style.top, left: win.style.left, width: win.style.width, height: win.style.height };
                  }
                 win.style.top = '0'; win.style.left = '0'; win.style.width = '100%'; win.style.height = 'calc(100% - 3.5rem)';
                 windowState.isMaximized = true;
             }
        }

        function updateTaskbar() {
            taskbarApps.innerHTML = '';
            const pinnedApps = ['files', 'browser', 'settings', 'about'];
            
            if (DEVICE_MODE === 'phone') {
                pinnedApps.forEach(appType => {
                     const appData = ALL_APPS.find(a => a.type === appType);
                     if(!appData) return;
                     const item = document.createElement('button');
                     item.className = 'taskbar-item h-12 w-12 flex items-center justify-center bg-transparent hover:bg-gray-700/50 rounded-lg';
                     item.innerHTML = `<span class="text-2xl">${appData.icon}</span>`;
                     item.title = appData.name;
                     item.onclick = () => createWindow(appData.type, { icon: appData.icon, title: appData.name });
                     taskbarApps.appendChild(item);
                });
            } else { // Desktop, tablet, etc.
                 openWindows.forEach((state, id) => {
                    if (state.isMinimized) return; // Don't show minimized on taskbar
                    const item = document.createElement('button');
                    item.className = 'taskbar-item h-10 w-10 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-md';
                    item.innerHTML = `<span class="text-2xl">${state.icon || 'üöÄ'}</span>`;
                    item.title = state.title;
                    if (parseInt(state.element.style.zIndex) === zIndexCounter - 1) item.classList.add('active', 'bg-gray-600');
                    item.onclick = () => {
                        if (parseInt(state.element.style.zIndex) === zIndexCounter - 1) {
                           toggleMinimize(id);
                        } else {
                           bringToFront(state.element);
                        }
                    };
                    taskbarApps.appendChild(item);
                 });
            }
        }
        
        function updateClock() {
            clockElement.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function toggleAppDrawer() {
            appDrawer.classList.toggle('show');
        }

        function initializeDesktop() {
            updateClock();
            setInterval(updateClock, 1000);
            
            if (DEVICE_MODE === 'phone') {
                desktopIconsContainer.style.display = 'none';
                startMenu.style.display = 'none';
                document.getElementById('startIcon').innerHTML = '‚ò∞';
                startButton.onclick = toggleAppDrawer;
                document.getElementById('clock').style.display = 'none';
                
                appDrawerGrid.innerHTML = '';
                ALL_APPS.forEach(appData => {
                    const iconEl = document.createElement('div');
                    iconEl.className = 'desktop-icon';
                    iconEl.innerHTML = `<span>${appData.icon}</span><p>${appData.name}</p>`;
                    iconEl.onclick = () => {
                        createWindow(appData.type, { icon: appData.icon, title: appData.name });
                        toggleAppDrawer();
                    };
                    appDrawerGrid.appendChild(iconEl);
                });

            } else { // Desktop, Tablet, Deck/VR
                startButton.addEventListener('click', (e) => { e.stopPropagation(); startMenu.classList.toggle('hidden'); });
                desktop.addEventListener('click', () => startMenu.classList.add('hidden'));
                
                startMenu.innerHTML = `<div class="p-2 font-bold border-b border-gray-700">Birb OS Fusion</div>`;
                const menuList = document.createElement('ul');
                ALL_APPS.forEach(app => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center gap-3 hover:bg-blue-500 rounded p-2 cursor-pointer';
                    li.innerHTML = `<span>${app.icon}</span> ${app.name}`;
                    li.onclick = () => createWindow(app.type, { icon: app.icon, title: app.name });
                    menuList.appendChild(li);
                });
                startMenu.appendChild(menuList);

                desktopIconsContainer.innerHTML = '';
                ALL_APPS.forEach(iconData => {
                    const iconEl = document.createElement('div');
                    iconEl.className = 'desktop-icon';
                    iconEl.innerHTML = `<span>${iconData.icon}</span><p>${iconData.name}</p>`;
                    iconEl.addEventListener('click', () => createWindow(iconData.type, { icon: iconData.icon, title: iconData.name }));
                    desktopIconsContainer.appendChild(iconEl);
                });
            }
            updateTaskbar();
        }

    </script>
</body>
</html>
